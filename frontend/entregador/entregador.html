<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Entrega - Pizzaria</title>
  <link rel="stylesheet" href="entregador.css">
</head>
<body>
  <header>
    <h1>Painel de Entregas</h1>
    <nav>
      <button onclick="window.location.href='../index.html?noRedirect=true'">Voltar</button>
      <span id="usuario-info"></span>
    </nav>
  </header>

  <main>
    <section class="pedidos-section">
      <h2>Pedidos Prontos para Entrega</h2>
      <div class="pedidos-grid" id="pedidosProntos">
        <!-- Pedidos serão inseridos aqui via JavaScript -->
      </div>
    </section>

    <section class="pedidos-section">
      <h2>Pedidos em Entrega</h2>
      <div class="pedidos-grid" id="pedidosEmEntrega">
        <!-- Pedidos em entrega serão inseridos aqui -->
      </div>
    </section>
  </main>

  <div id="messageContainer" class="message-container"></div>

  <template id="pedido-template">
    <div class="pedido-card">
      <div class="pedido-header">
        <h3>Pedido #<span class="pedido-numero"></span></h3>
        <span class="pedido-hora"></span>
      </div>
      <div class="pedido-cliente">
        <div class="cliente-info">
          <strong class="cliente-nome"></strong>
          <p class="cliente-endereco"></p>
        </div>
      </div>
      <div class="pedido-items">
        <!-- Items do pedido serão inseridos aqui -->
      </div>
      <div class="pedido-valor">
        <strong>Total: R$ <span class="valor-total"></span></strong>
      </div>
      <div class="pedido-actions">
        <button class="btn-retirar">Retirar para Entrega</button>
        <button class="btn-entregue">Marcar Entregue</button>
      </div>
    </div>
  </template>

  <script>
    // Função para mostrar mensagens temporárias
    function mostrarMensagem(texto, tipo = 'info') {
      const msg = document.createElement('div');
      msg.className = `message ${tipo}`;
      msg.textContent = texto;
      document.getElementById('messageContainer').appendChild(msg);
      setTimeout(() => msg.remove(), 3000);
    }

    // Verificação de autenticação e cargo
    window.addEventListener('DOMContentLoaded', async () => {
      const usuario = JSON.parse(localStorage.getItem('usuario') || '{}');
      const token = localStorage.getItem('token');

      // Permite acesso para entregadores e gerente mestre (ID 21)
      const isEntregador = usuario.isEntregador;
      const isGerenteMestre = usuario.isGerente && usuario.id === 21;

      if (!usuario || !token || (!isEntregador && !isGerenteMestre)) {
        alert('Acesso não autorizado');
        window.location.href = '../login/login.html';
        return;
      }

      // Mostra info do usuário
      document.getElementById('usuario-info').innerHTML = `
        <span>Olá, ${usuario.nome}</span>
        <button onclick="logout()" class="btn-logout">Sair</button>
      `;

      // Carrega pedidos iniciais
      await carregarPedidos();
      // Atualiza a cada 30 segundos
      setInterval(carregarPedidos, 30000);
    });

    function logout() {
      localStorage.removeItem('token');
      localStorage.removeItem('usuario');
      window.location.href = '../index.html';
    }

    async function carregarPedidos() {
      try {
        const token = localStorage.getItem('token');
        const response = await fetch('http://localhost:3001/pedido/entregas', {
          headers: {
            'Authorization': `Bearer ${token}`
          }
        });

        if (!response.ok) {
          const errorData = await response.json();
          console.error('Erro ao carregar pedidos:', response.status, errorData);
          mostrarMensagem(`Erro ao carregar pedidos: ${errorData.message || 'Erro desconhecido'}`, 'error');
          return;
        }
        
        const pedidos = await response.json();
        console.log('Pedidos carregados:', pedidos);
        
        const prontosDiv = document.getElementById('pedidosProntos');
        const entregaDiv = document.getElementById('pedidosEmEntrega');
        
        // Limpa as seções
        prontosDiv.innerHTML = '';
        entregaDiv.innerHTML = '';

        // Template para os cards
        const template = document.getElementById('pedido-template');

        pedidos.forEach(pedido => {
          const clone = template.content.cloneNode(true);
          
          // Preenche dados básicos
          clone.querySelector('.pedido-numero').textContent = pedido.id_pedido;
          clone.querySelector('.pedido-hora').textContent = new Date(pedido.data_pedido).toLocaleTimeString();

          // Preenche dados do cliente
          clone.querySelector('.cliente-nome').textContent = pedido.cliente_nome || 'Cliente';
          clone.querySelector('.cliente-endereco').textContent = pedido.endereco_cliente || 'Endereço não informado';

          // Lista os itens do pedido
          const itemsDiv = clone.querySelector('.pedido-items');
          if (pedido.items && pedido.items.length > 0) {
            pedido.items.forEach(item => {
              const itemEl = document.createElement('div');
              itemEl.className = 'pedido-item';
              itemEl.innerHTML = `
                <span class="item-qtd">${item.quantidade}x</span>
                <span class="item-nome">${item.nome_pizza}</span>
              `;
              itemsDiv.appendChild(itemEl);
            });
          } else {
            itemsDiv.innerHTML = '<p>Sem itens</p>';
          }

          // Preenche valor total
          clone.querySelector('.valor-total').textContent = Number(pedido.valor_total).toFixed(2);

          // Configura botões baseado no status
          const card = clone.querySelector('.pedido-card');
          const btnRetirar = clone.querySelector('.btn-retirar');
          const btnEntregue = clone.querySelector('.btn-entregue');

          if (pedido.status_pedido === 'Pronto') {
            btnEntregue.style.display = 'none';
            btnRetirar.onclick = () => iniciarEntrega(pedido.id_pedido);
            prontosDiv.appendChild(clone);
          } else if (pedido.status_pedido === 'Em Entrega') {
            btnRetirar.style.display = 'none';
            btnEntregue.onclick = () => marcarEntregue(pedido.id_pedido);
            entregaDiv.appendChild(clone);
          }
        });

        if (pedidos.length === 0) {
          prontosDiv.innerHTML = '<p>Nenhum pedido pronto para entrega</p>';
          entregaDiv.innerHTML = '<p>Nenhum pedido em entrega</p>';
        }

      } catch (error) {
        console.error('Erro:', error);
        mostrarMensagem('Erro ao carregar pedidos', 'error');
      }
    }

    async function iniciarEntrega(idPedido) {
      try {
        const token = localStorage.getItem('token');
        const response = await fetch(`http://localhost:3001/pedido/${idPedido}/entrega`, {
          method: 'PUT',
          headers: {
            'Authorization': `Bearer ${token}`
          }
        });

        if (!response.ok) throw new Error('Erro ao iniciar entrega');
        
        mostrarMensagem('Pedido saiu para entrega!', 'success');
        await carregarPedidos();
      } catch (error) {
        console.error('Erro:', error);
        mostrarMensagem('Erro ao iniciar entrega', 'error');
      }
    }

    async function marcarEntregue(idPedido) {
      try {
        const token = localStorage.getItem('token');
        const response = await fetch(`http://localhost:3001/pedido/${idPedido}/entregue`, {
          method: 'PUT',
          headers: {
            'Authorization': `Bearer ${token}`
          }
        });

        if (!response.ok) throw new Error('Erro ao marcar como entregue');
        
        mostrarMensagem('Pedido entregue com sucesso!', 'success');
        await carregarPedidos();
      } catch (error) {
        console.error('Erro:', error);
        mostrarMensagem('Erro ao marcar pedido como entregue', 'error');
      }
    }
  </script>
</body>
</html>