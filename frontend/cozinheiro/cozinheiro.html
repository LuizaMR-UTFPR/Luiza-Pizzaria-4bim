<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Cozinha - Pizzaria</title>
  <link rel="stylesheet" href="cozinheiro.css">
</head>
<body>
  <header>
    <h1>Painel do Cozinheiro</h1>
    <nav>
      <button onclick="window.location.href='../index.html?noRedirect=true'">Voltar</button>
      <span id="usuario-info"></span>
    </nav>
  </header>

  <main>
    <section class="pedidos-section">
      <h2>Pedidos Pendentes</h2>
      <div class="pedidos-grid" id="pedidosPendentes">
        <!-- Pedidos serão inseridos aqui via JavaScript -->
      </div>
    </section>

    <section class="pedidos-section">
      <h2>Pedidos em Preparo</h2>
      <div class="pedidos-grid" id="pedidosEmPreparo">
        <!-- Pedidos em preparo serão inseridos aqui -->
      </div>
    </section>
  </main>

  <div id="messageContainer" class="message-container"></div>

  <template id="pedido-template">
    <div class="pedido-card">
      <div class="pedido-header">
        <h3>Pedido #<span class="pedido-numero"></span></h3>
        <span class="pedido-hora"></span>
      </div>
      <div class="pedido-items">
        <!-- Items do pedido serão inseridos aqui -->
      </div>
      <div class="pedido-actions">
        <button class="btn-comecar">Começar Preparo</button>
        <button class="btn-pronto">Marcar como Pronto</button>
      </div>
    </div>
  </template>

  <script>
    // Função para mostrar mensagens temporárias
    function mostrarMensagem(texto, tipo = 'info') {
      const msg = document.createElement('div');
      msg.className = `message ${tipo}`;
      msg.textContent = texto;
      document.getElementById('messageContainer').appendChild(msg);
      setTimeout(() => msg.remove(), 3000);
    }

    // Verificação de autenticação e cargo
    window.addEventListener('DOMContentLoaded', async () => {
      const usuario = JSON.parse(localStorage.getItem('usuario') || '{}');
      const token = localStorage.getItem('token');

      // Permite acesso para cozinheiros e gerente mestre (ID 21)
      const isCozinheiro = usuario.isCozinheiro;
      const isGerenteMestre = usuario.isGerente && usuario.id === 21;

      if (!usuario || !token || (!isCozinheiro && !isGerenteMestre)) {
        alert('Acesso não autorizado');
        window.location.href = '../login/login.html';
        return;
      }

      // Mostra info do usuário
      document.getElementById('usuario-info').innerHTML = `
        <span>Olá, ${usuario.nome}</span>
        <button onclick="logout()" class="btn-logout">Sair</button>
      `;

      // Carrega pedidos iniciais
      await carregarPedidos();
      // Atualiza a cada 30 segundos
      setInterval(carregarPedidos, 30000);
    });

    function logout() {
      localStorage.removeItem('token');
      localStorage.removeItem('usuario');
      window.location.href = '../index.html';
    }

    async function carregarPedidos() {
      try {
        const token = localStorage.getItem('token');
        const response = await fetch('http://localhost:3001/pedido/pendentes', {
          headers: {
            'Authorization': `Bearer ${token}`
          }
        });

        if (!response.ok) {
          const errorData = await response.json();
          console.error('Erro ao carregar pedidos:', response.status, errorData);
          mostrarMensagem(`Erro ao carregar pedidos: ${errorData.message || 'Erro desconhecido'}`, 'error');
          return;
        }
        
        const pedidos = await response.json();
        console.log('Pedidos carregados:', pedidos);
        
        const pendentesDiv = document.getElementById('pedidosPendentes');
        const preparoDiv = document.getElementById('pedidosEmPreparo');
        
        // Limpa as seções
        pendentesDiv.innerHTML = '';
        preparoDiv.innerHTML = '';

        // Template para os cards
        const template = document.getElementById('pedido-template');

        pedidos.forEach(pedido => {
          const clone = template.content.cloneNode(true);
          
          // Preenche dados básicos
          clone.querySelector('.pedido-numero').textContent = pedido.id_pedido;
          clone.querySelector('.pedido-hora').textContent = new Date(pedido.data_pedido).toLocaleTimeString();

          // Lista os itens do pedido
          const itemsDiv = clone.querySelector('.pedido-items');
          if (pedido.items && pedido.items.length > 0) {
            pedido.items.forEach(item => {
              const itemEl = document.createElement('div');
              itemEl.className = 'pedido-item';
              itemEl.innerHTML = `
                <span class="item-qtd">${item.quantidade}x</span>
                <span class="item-nome">${item.nome_pizza}</span>
              `;
              itemsDiv.appendChild(itemEl);
            });
          } else {
            itemsDiv.innerHTML = '<p>Sem itens</p>';
          }

          // Configura botões baseado no status
          const card = clone.querySelector('.pedido-card');
          const btnComecar = clone.querySelector('.btn-comecar');
          const btnPronto = clone.querySelector('.btn-pronto');

          if (pedido.status_pedido === 'Pendente') {
            btnPronto.style.display = 'none';
            btnComecar.onclick = () => iniciarPreparo(pedido.id_pedido);
            pendentesDiv.appendChild(clone);
          } else if (pedido.status_pedido === 'Em Preparo') {
            btnComecar.style.display = 'none';
            btnPronto.onclick = () => marcarPronto(pedido.id_pedido);
            preparoDiv.appendChild(clone);
          }
        });

        if (pedidos.length === 0) {
          pendentesDiv.innerHTML = '<p>Nenhum pedido pendente</p>';
          preparoDiv.innerHTML = '<p>Nenhum pedido em preparo</p>';
        }

      } catch (error) {
        console.error('Erro:', error);
        mostrarMensagem('Erro ao carregar pedidos', 'error');
      }
    }

    async function iniciarPreparo(idPedido) {
      try {
        const token = localStorage.getItem('token');
        const response = await fetch(`http://localhost:3001/pedido/${idPedido}/preparo`, {
          method: 'PUT',
          headers: {
            'Authorization': `Bearer ${token}`
          }
        });

        if (!response.ok) throw new Error('Erro ao iniciar preparo');
        
        mostrarMensagem('Pedido em preparo!', 'success');
        await carregarPedidos();
      } catch (error) {
        console.error('Erro:', error);
        mostrarMensagem('Erro ao iniciar preparo', 'error');
      }
    }

    async function marcarPronto(idPedido) {
      try {
        const token = localStorage.getItem('token');
        const response = await fetch(`http://localhost:3001/pedido/${idPedido}/pronto`, {
          method: 'PUT',
          headers: {
            'Authorization': `Bearer ${token}`
          }
        });

        if (!response.ok) throw new Error('Erro ao marcar como pronto');
        
        mostrarMensagem('Pedido pronto para entrega!', 'success');
        await carregarPedidos();
      } catch (error) {
        console.error('Erro:', error);
        mostrarMensagem('Erro ao marcar pedido como pronto', 'error');
      }
    }
  </script>
</body>
</html>